generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  buyer
  seller
  admin              // Basic admin
  super_admin        // Full platform control
  finance_admin      // Financial operations only
  support_admin      // User support only
  compliance_admin   // Audit and compliance only
}

enum RiskLevel {
  low
  medium
  high
  critical
}

enum AuditStatus {
  success
  failure
  pending
  rolled_back
}

enum ApprovalStatus {
  pending
  approved
  rejected
  expired
  cancelled
}

enum ListingCategory {
  car
  house
  land
  commercial
  other
}

enum ListingType {
  sale
  rent
}

enum ListingStatus {
  pending
  approved
  rejected
  sold
  rented
  inactive
}

enum TransactionStatus {
  pending
  payment_initiated
  payment_completed
  escrowed
  released
  refunded
  cancelled
  disputed
  paid
}

enum PaymentMethod {
  telebirr
  chapa
  bibit
}

enum NotificationType {
  listing_approved
  listing_rejected
  payment_received
  escrow_released
  user_verified
  user_rejected
  transaction_completed
  transaction_cancelled
  dispute_initiated
  dispute_evidence_required
  dispute_resolved
  dispute_message
  system_announcement
  system_message
}

enum NotificationPriority {
  low
  medium
  high
  urgent
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  full_name     String
  phone         String?
  role          UserRole  @default(buyer)
  verified      Boolean   @default(false)
  avatar_url    String?
  address       Json?
  bank_details  Json?
  rating        Json      @default("{\"average\": 0, \"count\": 0}")
  is_active     Boolean   @default(true)
  last_login    DateTime?
  preferences   Json      @default("{\"notifications\": {\"email\": true, \"sms\": false, \"push\": true}, \"language\": \"en\", \"dark_mode\": false}")
  
  // Admin-specific fields (Phase 0: Control Layer)
  admin_metadata      Json?      // Admin-specific data
  permissions         String[]   @default([]) // Explicit permissions
  permission_groups   String[]   @default([]) // Permission group memberships
  last_password_change DateTime?
  mfa_enabled         Boolean    @default(false)
  mfa_secret          String?
  session_timeout     Int        @default(3600) // seconds
  failed_login_attempts Int      @default(0)
  locked_until        DateTime?
  ip_whitelist        String[]   @default([])
  
  listings      Listing[] @relation("UserListings")
  buys          Transaction[] @relation("BuyerTransactions")
  sells         Transaction[] @relation("SellerTransactions")
  notifications Notification[]
  favorites     Favorite[]
  inquiries     Inquiry[]
  
  // Audit trail relations (Phase 0: Control Layer)
  performed_actions   AuditLog[] @relation("PerformedBy")
  approved_actions    AuditLog[] @relation("ApprovedBy")
  admin_sessions      AdminSession[]
  requested_approvals ActionApproval[] @relation("RequestedActions")
  approved_approvals  ActionApproval[] @relation("ApprovedActions")

  // Dispute Management (Phase 1)
  initiated_disputes  Dispute[] @relation("DisputeInitiator")
  received_disputes   Dispute[] @relation("DisputeRespondent")
  managed_disputes    Dispute[] @relation("DisputeManager")
  dispute_evidence    DisputeEvidence[]
  dispute_messages    DisputeMessage[]
  
  // Document Verification (Phase 2)
  verification_requests VerificationRequest[]
  uploaded_documents   VerificationDocument[]
  reviewed_verifications VerificationRequest[] @relation("VerificationReviewer")
  triggered_notifications Notification[]        @relation("TriggeredNotifications")
  notification_preferences NotificationPreference?
  
  // Financial Management (Phase 4)
  seller_balance      SellerBalance?        @relation("SellerBalance")
  payout_requests     PayoutRequest[]       @relation("SellerPayouts")
  approved_payouts    PayoutRequest[]       @relation("PayoutApprover")
  rejected_payouts    PayoutRequest[]       @relation("PayoutRejecter")
  reconciled_payouts  PayoutRequest[]       @relation("PayoutReconciler")
  ledger_entries      LedgerEntry[]         @relation("LedgerCreator")
  initiated_refunds   RefundRecord[]        @relation("RefundInitiator")
  generated_reports   FinancialReport[]     @relation("ReportGenerator")
  seller_reports      FinancialReport[]     @relation("SellerReports")
  
  // Analytics, Configuration & Automation (Phase 5)
  created_configs     PlatformConfig[]      @relation("ConfigCreator")
  approved_configs    PlatformConfig[]      @relation("ConfigApprover")
  config_changes      ConfigChangeHistory[] @relation("ConfigChanger")
  owned_feature_flags FeatureFlag[]         @relation("FeatureFlagOwner")
  activated_maintenance MaintenanceMode[]   @relation("MaintenanceActivator")
  created_workflows   AutomationWorkflow[]  @relation("WorkflowCreator")
  approved_executions WorkflowExecution[]   @relation("ExecutionApprover")
  created_tasks       ScheduledTask[]       @relation("TaskCreator")
  
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  @@map("users")
}

model Listing {
  id                String          @id @default(uuid())
  title             String
  description       String
  category          ListingCategory
  subcategory       String?
  price             Float
  currency          String          @default("ETB")
  type              ListingType
  rent_period       String?
  location          Json
  images            Json
  documents         Json            @default("[]")
  features          Json            @default("{}")
  
  owner_id          String
  owner             User            @relation("UserListings", fields: [owner_id], references: [id])
  
  status            ListingStatus   @default(pending)
  verified          Boolean         @default(false)
  verification_notes String?
  views             Int             @default(0)
  tags              String[]        @default([])
  is_active         Boolean         @default(true)
  expires_at        DateTime?
  
  transactions      Transaction[]
  favorites         Favorite[]
  inquiries         Inquiry[]
  verification_requests VerificationRequest[]

  created_at        DateTime        @default(now())
  updated_at        DateTime        @updatedAt

  @@map("listings")
}

model Transaction {
  id              String            @id @default(uuid())
  listing_id      String
  listing         Listing           @relation(fields: [listing_id], references: [id])
  
  buyer_id        String
  buyer           User              @relation("BuyerTransactions", fields: [buyer_id], references: [id])
  
  seller_id       String
  seller          User              @relation("SellerTransactions", fields: [seller_id], references: [id])
  
  amount          Float
  currency        String            @default("ETB")
  commission      Json
  payment_method  PaymentMethod
  payment_details Json              @default("{}")
  
  status          TransactionStatus @default(pending)
  escrow          Json              @default("{\"is_escrowed\": false}")
  contract        Json              @default("{}")
  delivery        Json              @default("{}")
  dispute         Dispute?
  dispute_data    Json              @default("{\"is_disputed\": false}") // Renamed from 'dispute' to avoid conflict, legacy data
  refund          Json              @default("{}")
  timeline        Json              @default("[]")
  metadata        Json              @default("{}")
  verification_requests VerificationRequest[]
  
  // Financial Management (Phase 4)
  commission_record CommissionRecord?
  refund_records    RefundRecord[]
  ledger_entries    LedgerEntry[]

  created_at      DateTime          @default(now())
  updated_at      DateTime          @updatedAt

  @@map("transactions")
}

model Notification {
  id          String               @id @default(uuid())
  user_id     String
  user        User                 @relation(fields: [user_id], references: [id])
  
  type        NotificationType
  title       String
  message     String
  data        Json?
  priority    NotificationPriority @default(medium)
  channels    Json                 @default("{\"in_app\": true, \"email\": true, \"sms\": false, \"push\": false}")
  status      String               @default("pending")
  read        Boolean              @default(false)
  read_at     DateTime?
  sent_at     DateTime?
  delivered_at DateTime?
  expires_at  DateTime?
  metadata    Json                 @default("{\"retry_count\": 0}")
  
  // Template & Variables
  template_id     String?
  template        NotificationTemplate? @relation(fields: [template_id], references: [id])
  variables       Json                  @default("{}")
  
  // Delivery Tracking
  delivery_status Json                  @default("{}")
  failed_at       DateTime?
  failure_reason  String?
  retry_count     Int                   @default(0)
  max_retries     Int                   @default(3)
  
  // Event Context
  event_type      String?               // e.g., "escrow.released", "dispute.resolved"
  event_id        String?               // Reference to source event
  triggered_by_id String?               // Admin who triggered (if manual)
  triggered_by    User?                 @relation("TriggeredNotifications", fields: [triggered_by_id], references: [id])
  
  // Grouping & Threading
  thread_id       String?               // Group related notifications
  parent_id       String?               // Reply-to for threaded conversations
  parent          Notification?         @relation("NotificationThread", fields: [parent_id], references: [id])
  children        Notification[]        @relation("NotificationThread")
  
  // Scheduling
  scheduled_for   DateTime?             // Delayed delivery

  created_at  DateTime             @default(now())
  updated_at  DateTime             @updatedAt
  
  logs        NotificationLog[]

  @@index([user_id, read, created_at])
  @@index([event_type, created_at])
  @@index([scheduled_for])
  @@map("notifications")
}

model NotificationTemplate {
  id              String   @id @default(uuid())
  code            String   @unique  // e.g., "ESCROW_RELEASED"
  name            String
  description     String?
  
  // Content Templates
  title_template  String
  message_template String
  email_subject   String?
  email_body      String?  // HTML template
  sms_body        String?
  
  // Configuration
  default_priority NotificationPriority @default(medium)
  default_channels Json                 @default("{\"in_app\": true, \"email\": true, \"sms\": false}")
  
  // Variables Schema (for validation)
  required_vars   String[]             @default([])
  optional_vars   String[]             @default([])
  
  // Metadata
  category        String               // "transactional", "marketing", "system"
  is_active       Boolean              @default(true)
  event_types     String[]             @default([]) // Events that trigger this template
  
  notifications   Notification[]
  
  created_at      DateTime             @default(now())
  updated_at      DateTime             @updatedAt
  
  @@map("notification_templates")
}

model NotificationPreference {
  id              String   @id @default(uuid())
  user_id         String   @unique
  user            User     @relation(fields: [user_id], references: [id])
  
  // Channel Preferences
  email_enabled   Boolean  @default(true)
  sms_enabled     Boolean  @default(false)
  push_enabled    Boolean  @default(true)
  
  // Category Preferences
  transactional   Json     @default("{\"email\": true, \"sms\": true, \"push\": true}")
  marketing       Json     @default("{\"email\": true, \"sms\": false, \"push\": false}")
  system          Json     @default("{\"email\": true, \"sms\": false, \"push\": true}")
  
  // Frequency Control
  digest_mode     Boolean  @default(false)  // Bundle notifications
  digest_frequency String  @default("realtime") // "realtime", "hourly", "daily"
  quiet_hours     Json     @default("{\"enabled\": false, \"start\": \"22:00\", \"end\": \"08:00\"}")
  
  // Per-Event Overrides
  event_overrides Json     @default("{}")
  
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt
  
  @@map("notification_preferences")
}

model NotificationLog {
  id              String   @id @default(uuid())
  notification_id String
  notification    Notification @relation(fields: [notification_id], references: [id])
  
  channel         String   // "email", "sms", "push", "in_app"
  status          String   // "queued", "sent", "delivered", "failed", "bounced"
  
  // Delivery Details
  provider        String?  // "sendgrid", "twilio", etc.
  provider_id     String?  // External message ID
  provider_response Json?
  
  // Timing
  attempted_at    DateTime @default(now())
  completed_at    DateTime?
  
  // Error Tracking
  error_code      String?
  error_message   String?
  
  @@index([notification_id, channel])
  @@index([status, attempted_at])
  @@map("notification_logs")
}

model Favorite {
  id          String   @id @default(uuid())
  user_id     String
  user        User     @relation(fields: [user_id], references: [id])
  listing_id  String
  listing     Listing  @relation(fields: [listing_id], references: [id])
  created_at  DateTime @default(now())

  @@unique([user_id, listing_id])
  @@map("favorites")
}

model Inquiry {
  id          String   @id @default(uuid())
  user_id     String
  user        User     @relation(fields: [user_id], references: [id])
  listing_id  String
  listing     Listing  @relation(fields: [listing_id], references: [id])
  message     String
  contact     String?
  created_at  DateTime @default(now())

  @@map("inquiries")
}

// ============================================================================
// PHASE 0: CONTROL LAYER MODELS
// ============================================================================

model Permission {
  id          String   @id @default(uuid())
  name        String   @unique // e.g., "listings.approve", "users.verify"
  resource    String   // e.g., "listings", "users", "transactions"
  action      String   // e.g., "create", "read", "update", "delete", "approve"
  description String
  category    String   // e.g., "listing_management", "user_management"
  risk_level  RiskLevel @default(medium)
  
  groups      PermissionGroup[]
  
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  
  @@unique([resource, action])
  @@map("permissions")
}

model PermissionGroup {
  id          String   @id @default(uuid())
  name        String   @unique // e.g., "listing_manager", "finance_team"
  description String
  permissions Permission[]
  
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  
  @@map("permission_groups")
}

model AuditLog {
  id              String   @id @default(uuid())
  
  // Who performed the action
  performed_by_id String
  performed_by    User     @relation("PerformedBy", fields: [performed_by_id], references: [id])
  performed_by_role UserRole
  performed_by_ip String
  performed_by_user_agent String?
  
  // What action was performed
  action          String   // e.g., "listing.approve", "user.verify", "escrow.release"
  resource_type   String   // e.g., "Listing", "User", "Transaction"
  resource_id     String   // ID of the affected resource
  
  // Why it was performed
  reason          String?  // Admin-provided reason
  justification   String?  // Business justification
  
  // What changed
  before_state    Json?    // State before action
  after_state     Json?    // State after action
  changes         Json?    // Detailed diff of changes
  
  // Context
  request_id      String?  // For correlating related actions
  session_id      String?  // Admin session ID
  metadata        Json     @default("{}")
  
  // Risk assessment
  risk_level      RiskLevel
  requires_approval Boolean @default(false)
  approved_by_id  String?
  approved_by     User?    @relation("ApprovedBy", fields: [approved_by_id], references: [id])
  approved_at     DateTime?
  
  // Status
  status          AuditStatus @default(success)
  error_message   String?
  
  // Compliance
  retention_until DateTime? // For GDPR/compliance
  archived        Boolean   @default(false)
  
  created_at      DateTime  @default(now())
  
  @@index([performed_by_id, created_at])
  @@index([resource_type, resource_id])
  @@index([action, created_at])
  @@index([risk_level, created_at])
  @@map("audit_logs")
}

model AdminSession {
  id              String   @id @default(uuid())
  user_id         String
  user            User     @relation(fields: [user_id], references: [id])
  
  token           String   @unique
  refresh_token   String?  @unique
  
  ip_address      String
  user_agent      String?
  location        Json?    // Geolocation data
  
  expires_at      DateTime
  last_activity   DateTime @default(now())
  
  is_active       Boolean  @default(true)
  revoked         Boolean  @default(false)
  revoked_at      DateTime?
  revoked_reason  String?
  
  created_at      DateTime @default(now())
  
  @@index([user_id, is_active])
  @@index([token])
  @@map("admin_sessions")
}

model ActionApproval {
  id              String   @id @default(uuid())
  
  // Action details
  action_type     String
  resource_type   String
  resource_id     String
  action_data     Json
  
  // Requester
  requested_by_id String
  requested_by    User     @relation("RequestedActions", fields: [requested_by_id], references: [id])
  request_reason  String
  
  // Approver
  approved_by_id  String?
  approved_by     User?    @relation("ApprovedActions", fields: [approved_by_id], references: [id])
  approval_reason String?
  
  // Status
  status          ApprovalStatus @default(pending)
  expires_at      DateTime
  
  // Audit
  audit_log_id    String?  @unique
  
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt
  
  @@index([status, created_at])
  @@map("action_approvals")
}

// Phase 1: Dispute Management System

enum DisputeStatus {
  OPEN
  EVIDENCE_PENDING
  UNDER_REVIEW
  RESOLVED
  CLOSED
  CANCELLED
}

enum DisputeReason {
  ITEM_NOT_RECEIVED
  ITEM_NOT_AS_DESCRIBED
  DAMAGED_ITEM
  UNAUTHORIZED_TRANSACTION
  OTHER
}

enum DisputeResolution {
  REFUND_BUYER
  RELEASE_SELLER
  PARTIAL_REFUND
  DISMISSED
}

model Dispute {
  id              String            @id @default(uuid())
  transaction_id  String            @unique
  transaction     Transaction       @relation(fields: [transaction_id], references: [id])
  
  initiator_id    String
  initiator       User              @relation("DisputeInitiator", fields: [initiator_id], references: [id])
  
  respondent_id   String
  respondent      User              @relation("DisputeRespondent", fields: [respondent_id], references: [id])
  
  assigned_admin_id String?
  assigned_admin  User?             @relation("DisputeManager", fields: [assigned_admin_id], references: [id])
  
  status          DisputeStatus     @default(OPEN)
  reason          DisputeReason
  description     String
  amount_claimed  Float
  
  resolution      DisputeResolution?
  resolution_notes String?
  resolved_at     DateTime?
  
  admin_notes     String?           // Internal notes
  evidence_deadline DateTime?
  resolution_deadline DateTime?
  metadata        Json              @default("{}")
  
  evidence        DisputeEvidence[]
  messages        DisputeMessage[]
  
  created_at      DateTime          @default(now())
  updated_at      DateTime          @updatedAt

  @@map("disputes")
}

model DisputeEvidence {
  id          String   @id @default(uuid())
  dispute_id  String
  dispute     Dispute  @relation(fields: [dispute_id], references: [id])
  
  uploader_id String
  uploader    User     @relation(fields: [uploader_id], references: [id])
  
  file_url    String
  file_type   String   // IMAGE, DOCUMENT, VIDEO
  description String?
  
  created_at  DateTime @default(now())

  @@map("dispute_evidence")
}

model DisputeMessage {
  id          String   @id @default(uuid())
  dispute_id  String
  dispute     Dispute  @relation(fields: [dispute_id], references: [id])
  
  sender_id   String
  sender      User     @relation(fields: [sender_id], references: [id])
  
  content     String
  is_internal Boolean  @default(false) // Admin-only notes
  
  created_at  DateTime @default(now())

  @@map("dispute_messages")
}

// Phase 2: Document Verification System

enum VerificationRequestStatus {
  PENDING
  IN_REVIEW
  APPROVED
  REJECTED
  RE_REQUESTED
  CANCELLED
}

enum VerificationDocumentStatus {
  PENDING
  VERIFIED
  REJECTED
  EXPIRED
}

enum VerificationScope {
  USER_IDENTITY
  USER_KYB
  LISTING_OWNERSHIP
  LISTING_REGISTRATION
  TRANSACTION_OBLIGATION
}

model VerificationDocumentType {
  id              String            @id @default(uuid())
  name            String            @unique
  code            String            @unique // e.g., PASSPORT, TITLE_DEED
  description     String?
  scope           VerificationScope
  required        Boolean           @default(false)
  
  documents       VerificationDocument[]
  
  @@map("verification_document_types")
}

model VerificationRequest {
  id              String                    @id @default(uuid())
  status          VerificationRequestStatus @default(PENDING)
  scope           VerificationScope
  
  // Relations
  user_id         String
  user            User                      @relation(fields: [user_id], references: [id])
  
  listing_id      String?
  listing         Listing?                  @relation(fields: [listing_id], references: [id])
  
  transaction_id  String?
  transaction     Transaction?              @relation(fields: [transaction_id], references: [id])
  
  assigned_admin_id String?
  assigned_admin  User?                     @relation("VerificationReviewer", fields: [assigned_admin_id], references: [id])
  
  documents       VerificationDocument[]
  
  // Decisions
  rejection_reason String?
  admin_notes      String?
  confidence_score Float?                   // Hidden platform metric (1-10)
  
  expires_at      DateTime?
  last_review_at  DateTime?
  
  created_at      DateTime                  @default(now())
  updated_at      DateTime                  @updatedAt

  @@map("verification_requests")
}

model VerificationDocument {
  id              String                     @id @default(uuid())
  request_id      String
  request         VerificationRequest        @relation(fields: [request_id], references: [id])
  
  type_id         String
  type            VerificationDocumentType   @relation(fields: [type_id], references: [id])
  
  uploader_id     String
  uploader        User                       @relation(fields: [uploader_id], references: [id])
  
  file_url        String
  file_name       String
  file_size       Int
  file_type       String                     // MIME type
  
  status          VerificationDocumentStatus @default(PENDING)
  rejection_reason String?
  
  confidence_signal Float?                   // Internal trust signal (1-10)
  
  issue_date      DateTime?
  expiry_date     DateTime?
  
  metadata        Json                       @default("{}")
  
  created_at      DateTime                   @default(now())
  updated_at      DateTime                   @updatedAt

  @@map("verification_documents")
}

// ============================================================================
// PHASE 4: FINANCIAL MANAGEMENT & PAYOUT ENGINE
// ============================================================================

model SellerBalance {
  id                String   @id @default(uuid())
  user_id           String   @unique
  user              User     @relation("SellerBalance", fields: [user_id], references: [id])
  
  // Balance Tracking
  available_balance Decimal  @default(0) @db.Decimal(12, 2)  // Can withdraw
  pending_balance   Decimal  @default(0) @db.Decimal(12, 2)  // In escrow/processing
  total_earned      Decimal  @default(0) @db.Decimal(12, 2)  // Lifetime earnings
  total_withdrawn   Decimal  @default(0) @db.Decimal(12, 2)  // Lifetime withdrawals
  
  // Metadata
  currency          String   @default("ETB")
  last_payout_at    DateTime?
  
  // Relations
  ledger_entries    LedgerEntry[]
  payout_requests   PayoutRequest[]
  
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  
  @@map("seller_balances")
}

enum LedgerEntryType {
  CREDIT              // Money added to balance
  DEBIT               // Money removed from balance
  HOLD                // Money reserved (pending)
  RELEASE_HOLD        // Reserved money released
}

enum LedgerEntrySource {
  ESCROW_RELEASE      // From escrow release
  PAYOUT_COMPLETED    // Payout successful
  PAYOUT_FAILED       // Payout failed (reversal)
  PAYOUT_REQUESTED    // Payout hold
  PAYOUT_REJECTED     // Payout rejection (release hold)
  REFUND_ISSUED       // Refund to buyer
  COMMISSION_EARNED   // Platform commission
  ADJUSTMENT          // Manual admin adjustment
}

model LedgerEntry {
  id                String            @id @default(uuid())
  
  // Account Reference
  seller_balance_id String
  seller_balance    SellerBalance     @relation(fields: [seller_balance_id], references: [id])
  
  // Entry Details
  type              LedgerEntryType
  source            LedgerEntrySource
  amount            Decimal           @db.Decimal(12, 2)
  currency          String            @default("ETB")
  
  // Balance Snapshots (for reconciliation)
  balance_before    Decimal           @db.Decimal(12, 2)
  balance_after     Decimal           @db.Decimal(12, 2)
  
  // References
  transaction_id    String?           // Source transaction
  transaction       Transaction?      @relation(fields: [transaction_id], references: [id])
  payout_request_id String?           // Related payout
  payout_request    PayoutRequest?    @relation(fields: [payout_request_id], references: [id])
  
  // Metadata
  description       String
  metadata          Json              @default("{}")
  
  // Integrity Chain
  sequence          Int               @default(0) // 0 for genesis/migration filler
  previous_hash     String?           
  hash              String            @default("")

  // Audit
  created_by_id     String?
  created_by        User?             @relation("LedgerCreator", fields: [created_by_id], references: [id])
  
  created_at        DateTime          @default(now())
  
  @@unique([seller_balance_id, sequence])
  @@index([seller_balance_id, created_at])
  @@index([transaction_id])
  @@index([payout_request_id])
  @@map("ledger_entries")
}

enum PayoutRequestStatus {
  PENDING           // Awaiting admin approval
  APPROVED          // Admin approved, ready for processing
  REJECTED          // Admin rejected
  PROCESSING        // Payment in progress
  COMPLETED         // Successfully paid out
  FAILED            // Payment failed
  CANCELLED         // Cancelled by seller/admin
}

model PayoutRequest {
  id                String              @id @default(uuid())
  
  // Seller Reference
  seller_id         String
  seller            User                @relation("SellerPayouts", fields: [seller_id], references: [id])
  seller_balance_id String
  seller_balance    SellerBalance       @relation(fields: [seller_balance_id], references: [id])
  
  // Payout Details
  amount            Decimal             @db.Decimal(12, 2)
  currency          String              @default("ETB")
  status            PayoutRequestStatus @default(PENDING)
  
  // Payment Method
  payment_method    String              // "bank_transfer", "mobile_money"
  payment_details   Json                // Encrypted bank/mobile details
  
  // Approval Workflow
  requested_at      DateTime            @default(now())
  approved_at       DateTime?
  approved_by_id    String?
  approved_by       User?               @relation("PayoutApprover", fields: [approved_by_id], references: [id])
  
  rejected_at       DateTime?
  rejected_by_id    String?
  rejected_by       User?               @relation("PayoutRejecter", fields: [rejected_by_id], references: [id])
  rejection_reason  String?
  
  // Processing
  processing_started_at DateTime?
  completed_at      DateTime?
  failed_at         DateTime?
  failure_reason    String?
  
  // External Provider
  provider          String?             // "stripe", "paypal", "chapa"
  provider_payout_id String?            // External reference
  provider_response Json?
  
  // Reconciliation
  reconciled        Boolean             @default(false)
  reconciled_at     DateTime?
  reconciled_by_id  String?
  reconciled_by     User?               @relation("PayoutReconciler", fields: [reconciled_by_id], references: [id])
  
  // Retry Logic
  retry_count       Int                 @default(0)
  max_retries       Int                 @default(3)
  next_retry_at     DateTime?
  
  // Metadata
  notes             String?
  metadata          Json                @default("{}")
  
  // Relations
  ledger_entries    LedgerEntry[]
  
  created_at        DateTime            @default(now())
  updated_at        DateTime            @updatedAt
  
  @@index([seller_id, status])
  @@index([status, requested_at])
  @@map("payout_requests")
}

model CommissionRecord {
  id                String      @id @default(uuid())
  
  // Transaction Reference
  transaction_id    String      @unique
  transaction       Transaction @relation(fields: [transaction_id], references: [id])
  
  // Amounts
  gross_amount      Decimal     @db.Decimal(12, 2)  // Total transaction amount
  platform_fee      Decimal     @db.Decimal(12, 2)  // FreeLync commission
  platform_fee_pct  Decimal     @db.Decimal(5, 2)   // Percentage (e.g., 2.50)
  processor_fee     Decimal     @db.Decimal(12, 2)  // Payment gateway fee
  net_amount        Decimal     @db.Decimal(12, 2)  // Amount to seller
  
  currency          String      @default("ETB")
  
  // Calculation Details
  calculation_method String     // "percentage", "tiered", "flat"
  calculation_metadata Json     @default("{}")
  
  // Audit
  calculated_at     DateTime    @default(now())
  
  @@map("commission_records")
}

enum RefundStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model RefundRecord {
  id                String        @id @default(uuid())
  
  // Transaction Reference
  transaction_id    String
  transaction       Transaction   @relation(fields: [transaction_id], references: [id])
  
  // Refund Details
  amount            Decimal       @db.Decimal(12, 2)
  currency          String        @default("ETB")
  status            RefundStatus  @default(PENDING)
  
  // Reason
  reason            String
  initiated_by_id   String
  initiated_by      User          @relation("RefundInitiator", fields: [initiated_by_id], references: [id])
  
  // Commission Reversal
  reverse_platform_fee Boolean    @default(true)
  reversed_fee      Decimal?      @db.Decimal(12, 2)
  
  // Processing
  processed_at      DateTime?
  failed_at         DateTime?
  failure_reason    String?
  
  // External Provider
  provider          String?
  provider_refund_id String?
  provider_response Json?
  
  // Metadata
  metadata          Json          @default("{}")
  
  created_at        DateTime      @default(now())
  updated_at        DateTime      @updatedAt
  
  @@index([transaction_id])
  @@map("refund_records")
}

enum ReportType {
  DAILY_SUMMARY
  MONTHLY_SUMMARY
  SELLER_STATEMENT
  TAX_REPORT
  COMMISSION_REPORT
  RECONCILIATION_REPORT
}

model FinancialReport {
  id                String      @id @default(uuid())
  
  type              ReportType
  period_start      DateTime
  period_end        DateTime
  
  // Scope
  seller_id         String?     // For seller-specific reports
  seller            User?       @relation("SellerReports", fields: [seller_id], references: [id])
  
  // Report Data
  summary           Json        // High-level metrics
  details           Json        // Detailed breakdown
  
  // Export
  file_url          String?     // S3/storage URL
  file_format       String?     // "pdf", "csv", "excel"
  
  // Generation
  generated_at      DateTime    @default(now())
  generated_by_id   String?
  generated_by      User?       @relation("ReportGenerator", fields: [generated_by_id], references: [id])
  
  @@index([type, period_start])
  @@index([seller_id, period_start])
  @@map("financial_reports")
}

// ============================================================================
// PHASE 5: ANALYTICS, CONFIGURATION & AUTOMATION LAYER
// ============================================================================

enum MetricType {
  REVENUE
  TRANSACTION_COUNT
  USER_GROWTH
  LISTING_GROWTH
  PAYOUT_VOLUME
  COMMISSION_EARNED
  DISPUTE_RATE
  VERIFICATION_RATE
  CONVERSION_RATE
}

enum MetricPeriod {
  HOURLY
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

model PlatformMetric {
  id              String        @id @default(uuid())
  
  // Metric Identity
  type            MetricType
  period          MetricPeriod
  period_start    DateTime
  period_end      DateTime
  
  // Metric Values
  value           Decimal       @db.Decimal(15, 2)
  count           Int?          // For countable metrics
  percentage      Decimal?      @db.Decimal(5, 2)  // For rate metrics
  
  // Breakdown (JSON for flexibility)
  breakdown       Json          @default("{}")  // e.g., by category, region
  
  // Metadata
  currency        String        @default("ETB")
  calculated_at   DateTime      @default(now())
  
  @@unique([type, period, period_start])
  @@index([type, period_start])
  @@map("platform_metrics")
}

model AnalyticsSnapshot {
  id              String   @id @default(uuid())
  
  snapshot_date   DateTime @default(now())
  
  // User Metrics
  total_users     Int
  active_users    Int      // Active in last 30 days
  verified_users  Int
  
  // Listing Metrics
  total_listings  Int
  active_listings Int
  sold_listings   Int
  
  // Transaction Metrics
  total_transactions Int
  completed_transactions Int
  disputed_transactions Int
  
  // Financial Metrics
  total_revenue   Decimal  @db.Decimal(15, 2)
  total_payouts   Decimal  @db.Decimal(15, 2)
  pending_escrow  Decimal  @db.Decimal(15, 2)
  
  // Metadata
  metadata        Json     @default("{}")
  
  @@index([snapshot_date])
  @@map("analytics_snapshots")
}

enum ConfigCategory {
  COMMISSION
  PAYMENT_GATEWAY
  FEATURE_FLAG
  SYSTEM_SETTING
  INTEGRATION
  SECURITY
}

enum ConfigStatus {
  DRAFT           // Being edited
  PENDING         // Awaiting approval
  ACTIVE          // Currently in use
  SCHEDULED       // Scheduled for future activation
  ARCHIVED        // No longer in use
}

model PlatformConfig {
  id              String        @id @default(uuid())
  
  // Config Identity
  key             String        @unique  // e.g., "commission.tier1.rate"
  category        ConfigCategory
  name            String
  description     String?
  
  // Config Value
  value           Json          // Flexible value storage
  value_type      String        // "number", "string", "boolean", "json"
  
  // Validation
  validation_rules Json         @default("{}")  // Min/max, regex, etc.
  
  // Status & Lifecycle
  status          ConfigStatus  @default(DRAFT)
  version         Int           @default(1)
  
  // Scheduling
  scheduled_at    DateTime?     // When to activate
  activated_at    DateTime?
  deactivated_at  DateTime?
  
  // Approval Workflow
  created_by_id   String
  created_by      User          @relation("ConfigCreator", fields: [created_by_id], references: [id])
  
  approved_by_id  String?
  approved_by     User?         @relation("ConfigApprover", fields: [approved_by_id], references: [id])
  approved_at     DateTime?
  
  // Audit
  change_history  ConfigChangeHistory[]
  
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt
  
  @@index([category, status])
  @@index([key, version])
  @@map("platform_configs")
}

model ConfigChangeHistory {
  id              String        @id @default(uuid())
  
  config_id       String
  config          PlatformConfig @relation(fields: [config_id], references: [id])
  
  // Change Details
  version         Int
  previous_value  Json?
  new_value       Json
  
  // Change Reason
  change_reason   String
  change_type     String        // "created", "updated", "activated", "deactivated"
  
  // Actor
  changed_by_id   String
  changed_by      User          @relation("ConfigChanger", fields: [changed_by_id], references: [id])
  
  // Impact Assessment
  affected_users  Int?          // Estimated users affected
  affected_transactions Int?
  risk_level      String        // "low", "medium", "high", "critical"
  
  // Rollback
  can_rollback    Boolean       @default(true)
  rolled_back     Boolean       @default(false)
  rolled_back_at  DateTime?
  
  created_at      DateTime      @default(now())
  
  @@index([config_id, version])
  @@map("config_change_history")
}

enum FeatureFlagStatus {
  DISABLED
  ENABLED_FOR_TESTING
  ENABLED_FOR_PERCENTAGE
  ENABLED_FOR_USERS
  ENABLED_GLOBALLY
}

model FeatureFlag {
  id              String            @id @default(uuid())
  
  // Flag Identity
  key             String            @unique  // e.g., "new_checkout_flow"
  name            String
  description     String?
  
  // Status
  status          FeatureFlagStatus @default(DISABLED)
  
  // Targeting
  enabled_percentage Decimal?       @db.Decimal(5, 2)  // 0-100
  enabled_user_ids   String[]       @default([])
  enabled_roles      String[]       @default([])
  
  // Metadata
  owner_id        String
  owner           User              @relation("FeatureFlagOwner", fields: [owner_id], references: [id])
  
  tags            String[]          @default([])
  
  // Lifecycle
  enabled_at      DateTime?
  disabled_at     DateTime?
  
  created_at      DateTime          @default(now())
  updated_at      DateTime          @updatedAt
  
  @@index([status])
  @@map("feature_flags")
}

enum MaintenanceType {
  FULL            // Platform completely unavailable
  READ_ONLY       // No writes allowed
  FEATURE_SPECIFIC // Specific features disabled
}

model MaintenanceMode {
  id              String          @id @default(uuid())
  
  type            MaintenanceType
  
  // Scope
  affected_features String[]      @default([])  // For FEATURE_SPECIFIC
  
  // Messaging
  title           String
  message         String
  estimated_end   DateTime?
  
  // Status
  is_active       Boolean         @default(false)
  
  // Scheduling
  scheduled_start DateTime?
  scheduled_end   DateTime?
  
  // Activation
  activated_by_id String?
  activated_by    User?           @relation("MaintenanceActivator", fields: [activated_by_id], references: [id])
  activated_at    DateTime?
  
  deactivated_at  DateTime?
  
  created_at      DateTime        @default(now())
  updated_at      DateTime        @updatedAt
  
  @@index([is_active])
  @@map("maintenance_modes")
}

enum WorkflowTriggerType {
  SCHEDULED       // Cron-based
  EVENT           // Platform event
  STATE_CHANGE    // Entity state change
  MANUAL          // Admin-triggered
}

enum WorkflowStatus {
  DRAFT
  ACTIVE
  PAUSED
  ARCHIVED
}

model AutomationWorkflow {
  id              String              @id @default(uuid())
  
  // Workflow Identity
  name            String
  description     String?
  
  // Trigger Configuration
  trigger_type    WorkflowTriggerType
  trigger_config  Json                // Cron expression, event type, etc.
  
  // Actions
  actions         Json                // Array of actions to execute
  
  // Status
  status          WorkflowStatus      @default(DRAFT)
  
  // Execution Settings
  max_retries     Int                 @default(3)
  timeout_seconds Int                 @default(300)
  
  // Safety
  dry_run_mode    Boolean             @default(false)
  requires_approval Boolean           @default(false)
  
  // Metadata
  created_by_id   String
  created_by      User                @relation("WorkflowCreator", fields: [created_by_id], references: [id])
  
  tags            String[]            @default([])
  
  // Execution History
  executions      WorkflowExecution[]
  
  // Stats
  total_executions Int                @default(0)
  success_count   Int                 @default(0)
  failure_count   Int                 @default(0)
  
  last_executed_at DateTime?
  
  created_at      DateTime            @default(now())
  updated_at      DateTime            @updatedAt
  
  @@index([status, trigger_type])
  @@map("automation_workflows")
}

enum ExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
  REQUIRES_APPROVAL
}

model WorkflowExecution {
  id              String          @id @default(uuid())
  
  workflow_id     String
  workflow        AutomationWorkflow @relation(fields: [workflow_id], references: [id])
  
  // Execution Details
  status          ExecutionStatus @default(PENDING)
  
  // Trigger Context
  triggered_by    String          // "schedule", "event", "admin"
  trigger_data    Json            @default("{}")
  
  // Execution Trace
  started_at      DateTime?
  completed_at    DateTime?
  duration_ms     Int?
  
  // Actions Executed
  actions_executed Json           @default("[]")  // Array of action results
  
  // Results
  success         Boolean?
  error_message   String?
  error_stack     String?
  
  // Output
  output_data     Json            @default("{}")
  affected_entities Json          @default("{}")  // What was changed
  
  // Retry
  retry_count     Int             @default(0)
  
  // Approval (if required)
  approved_by_id  String?
  approved_by     User?           @relation("ExecutionApprover", fields: [approved_by_id], references: [id])
  approved_at     DateTime?
  
  created_at      DateTime        @default(now())
  
  @@index([workflow_id, created_at])
  @@index([status])
  @@map("workflow_executions")
}

enum TaskStatus {
  SCHEDULED
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

model ScheduledTask {
  id              String      @id @default(uuid())
  
  // Task Identity
  name            String
  description     String?
  task_type       String      // "send_notification", "generate_report", etc.
  
  // Scheduling
  scheduled_for   DateTime
  recurrence      String?     // Cron expression for recurring tasks
  
  // Payload
  payload         Json        @default("{}")
  
  // Status
  status          TaskStatus  @default(SCHEDULED)
  
  // Execution
  executed_at     DateTime?
  completed_at    DateTime?
  error_message   String?
  
  // Result
  result          Json?
  
  // Metadata
  created_by_id   String
  created_by      User        @relation("TaskCreator", fields: [created_by_id], references: [id])
  
  created_at      DateTime    @default(now())
  updated_at      DateTime    @updatedAt
  
  @@index([status, scheduled_for])
  @@map("scheduled_tasks")
}
